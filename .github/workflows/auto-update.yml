name: Auto-update casks on new releases

on:
  workflow_dispatch:
  schedule:
    # Run every day at 1:00 AM UTC
    - cron: "0 1 * * *"

jobs:
  scheduled:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check out this repo
        uses: actions/checkout@v5
      - name: Fetch latest versions
        id: versions
        run: |-
          MILLISECONDS=$(date '+%s')$(($RANDOM % 1000))
          latest=$(curl "https://download2.interactivebrokers.com/installers/tws/latest-standalone/version.json?_=$MILLISECONDS&callback=twslatest_callback" | jq -R 'capture("\\((?<x>.*)\\)[^)]*$").x | fromjson | .buildVersion')
          stable=$(curl "https://download2.interactivebrokers.com/installers/tws/stable-standalone/version.json?_=$MILLISECONDS&callback=twsstable_callback" | jq -R 'capture("\\((?<x>.*)\\)[^)]*$").x | fromjson | .buildVersion')
          beta=$(curl "https://download2.interactivebrokers.com/installers/tws/beta/version.json?_=$MILLISECONDS&callback=twsbetaupdatable_callback" | jq -R 'capture("\\((?<x>.*)\\)[^)]*$").x | fromjson | .buildVersion')
          ntws_latest=$(curl "https://download2.interactivebrokers.com/installers/ntws/latest-standalone/version.json?_=$MILLISECONDS&callback=ntwslatest_callback" | jq -R 'capture("\\((?<x>.*)\\)[^)]*$").x | fromjson | .buildVersion')
          ntws_beta=$(curl "https://download2.interactivebrokers.com/installers/ntws/beta-standalone/version.json?_=$MILLISECONDS&callback=ntwsbeta_callback" | jq -R 'capture("\\((?<x>.*)\\)[^)]*$").x | fromjson | .buildVersion')

          echo "latest=$latest" >> GITHUB_OUTPUT
          echo "stable=$stable" >> GITHUB_OUTPUT
          echo "beta=$beta" >> GITHUB_OUTPUT
          echo "ntws_latest=$ntws_latest" >> GITHUB_OUTPUT
          echo "ntws_beta=$ntws_beta" >> GITHUB_OUTPUT
      - name: Update Casks
        run: |-
          sed -i "s/version .*/version ${{ steps.versions.outputs.latest }}/g" Casks/trader-workstation-latest.rb
          sed -i "s/version .*/version ${{ steps.versions.outputs.stable }}/g" Casks/trader-workstation-stable.rb
          sed -i "s/version .*/version ${{ steps.versions.outputs.beta }}/g" Casks/trader-workstation-beta.rb
          sed -i "s/version .*/version ${{ steps.versions.outputs.ntws_latest }}/g" Casks/ibkr-desktop-latest.rb
          sed -i "s/version .*/version ${{ steps.versions.outputs.ntws_beta }}/g" Casks/ibkr-desktop-beta.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Auto-update TWS Casks: $(date -u)"
          branch: auto/update-casks
          branch-suffix: timestamp
          title: "Auto-update TWS Casks"
          body: |
            Automated update of Trader Workstation and IBKR Desktop casks.

            - Latest: ${{ steps.versions.outputs.latest }}
            - Stable: ${{ steps.versions.outputs.stable }}
            - Beta: ${{ steps.versions.outputs.beta }}
            - IBKR Desktop: ${{ steps.versions.outputs.ntws_latest }}
            - IBKR Desktop Beta: ${{ steps.versions.outputs.ntws_beta }}
          labels: automated
          delete-branch: true
          draft: false
          signoff: true
          merge-method: squash
          auto-merge: true
